<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on 星期三, 一月 27, 2016, 6:23 下午 -->
<!-- MuClient version 4.73 -->

<!-- Plugin "rbt_update" generated by Plugin Wizard -->

<muclient>
<plugin
   name="rbt_update"
   author="叶知秋"
   id="5c589f1ca4fd208978a46254"
   language="Lua"
   purpose="书剑机器人自动更新"
   date_written="2016-01-27 18:22:02"
   requires="4.73"
   version="3.11"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->


<script>
<![CDATA[

--获取ftpConfig 文件 知道所有文件 ftp路径  保存文件名
--json 格式 ftp 路径
--{"ftplist":[{"ftp":"","local":"","filename":"","version":"1.0"},{"ftp":"","local":"","filename":,""}]}

require "webServer" --加载webServer

local function serialize(obj)
    local lua = ""
    local t = type(obj)
    if t == "number" then
        lua = lua .. obj
    elseif t == "boolean" then
        lua = lua .. tostring(obj)
    elseif t == "string" then
        lua = lua .. string.format("%q", obj)
    elseif t == "table" then
        lua = lua .. "{\n"
    for k, v in pairs(obj) do
        lua = lua .. "[" .. serialize(k) .. "]=" .. serialize(v) .. ",\n"
    end
    local metatable = getmetatable(obj)
        if metatable ~= nil and type(metatable.__index) == "table" then
        for k, v in pairs(metatable.__index) do
            lua = lua .. "[" .. serialize(k) .. "]=" .. serialize(v) .. ",\n"
        end
    end
        lua = lua .. "}"
    elseif t == "nil" then
        return nil
    else
        error("can not serialize a " .. t .. " type.")
    end
    return lua
end

local function unserialize(lua)
    local t = type(lua)
    if t == "nil" or lua == "" then
        return nil
    elseif t == "number" or t == "string" or t == "boolean" then
        lua = tostring(lua)
    else
        error("can not unserialize a " .. t .. " type.")
    end
    lua = "return " .. lua
    local func = loadstring(lua)
    if func == nil then
        return nil
    end
    return func()
end

local ftp = require("socket.ftp")
-- Log as user "anonymous" on server "ftp.tecgraf.puc-rio.br",
-- and get file "lua.tar.gz" from directory "pub/lua" as binary.
ftp.USER = "mc"
ftp.PASSWORD = "Mcc0121"

local local_config={}
if t~=nil then
   local_config=unserialize(t)
end
--创建需要更新的配置文件
function create()
   local config_txt=io.open("update_log.txt","r")
   local _config=config_txt:read("*a")
   print(_config)
   config_txt:close()
   local b=unserialize(_config)
   --print(_config)
   for k,c in pairs(b) do
     print(c.path,c.filename)
     local output=c.path..c.filename
	 --print(output)
	 f = io.open (output, "rb")
     if f then
       local md5=utils.tohex (utils.md5 (f:read ("*a")))
	   print(c.filename.." md5:"..md5)
       f:close ()
	   b[k].md5=md5
     end -- if
   end
   local f=serialize(b)
   local output="AutoUpdate_Config.txt"
   local file = io.open(output,"wb")

      file:write(f)
      file:flush()
      file:close()
	  print("配置文件生成结束！")
end


function check()
   local ftp_file=""
   local ftp_co=nil
   ftp_co=coroutine.create(function()
      --下载服务器上的配置文件进行比对
   --print(f,"******")

    --[[if ftp_file==nil then
      	 print("下载超时,更换http方式")
	    ftp_file= webServer:downloadFile("http://112.65.143.180:9001/download/mushclient/AutoUpdate_Config.txt")
    end]]
	if ftp_file==nil then
       print("下载超时,更新未成功!!")
	   return
	end
    --下载服务器上的配置文件进行比对

   local remote_config={}
   remote_config=unserialize(ftp_file)
   local is_updated=false
   local log=""
   for k,c in pairs(remote_config) do
     local output=c.path..c.filename
	 --print(output)
	 local md5=""
	 f = io.open (output, "rb")
      if f then
         md5=utils.tohex (utils.md5 (f:read ("*a")))
	     -- print(md5)
		 f:close ()
      end -- if
      if md5=="" or md5~=c.md5 then  --不同服务器上版本
	      local yesno=utils.msgbox ("发现文件有更新是否更新文件"..c.filename.." "..c.description.."?", "更新", "yesno", "?")
	     if yesno=="no" then

         else
		  is_updated=true
	      print("更新模块:"..c.description.." 文件:"..c.filename)
		  print(c.ftp," 下载中！")
	      local e1
		  ftp_file,e1=ftp.get(c.ftp)
          print(ftp_file)

		  if ftp_file==nil or ftp_file=="" then
		    --[[ print("下载超时,更换http方式")
			print(c.http," 下载中")
			local http_file= webServer:downloadFile(c.http)
			if http_file~=nil then
			 local file1 = io.open(output,"wb")
             file1:write(http_file)
             file1:flush()
             file1:close()
		     if c.log==nil then
			   c.log=""
			 end
			 log=log..c.log.."\n"
			else]]
             print("下载超时,更新未成功!!")
			--end
		  else
		    print(c.filename,"下载完成")
			local file1 = io.open(output,"wb")
             file1:write(ftp_file)
             file1:flush()
             file1:close()
		    if c.log==nil then c.log="" end
		       log=log..c.log.."\n"
		    end
		  end
	  else
		  -- print("模块"..k.."已经是最新的了！")
	  end

   end
   print("更新完毕!")
   if is_updated then
	    print("更新内容")
		print("-------------------------")
		print(log)
		print("-------------------------")
	    print("请重新加载脚本和数据库！")

   else
	  print("未发现更新！")
	  world.EnableTimer("update_check",true)
   end
   end)

   local e
   ftp_file, e = ftp.get("ftp://122.152.208.225//mushclient//AutoUpdate_Config.txt")
   print(ftp_file)
   coroutine.resume(ftp_co)

end

local the_most_new=false
function is_up_to_date()
   local ftp_file=""
   local ftp_co=nil
   print("检测机器人更新")
  -- print(ftp_file)
    the_most_new=true  --最新的

  ftp_co=coroutine.create(function()

  --[[ if ftp_file==nil then
     print("检测超时")
	 print("下载超时,更换http方式")
	ftp_file= webServer:downloadFile("http://112.65.143.180:9001/download/mushclient/AutoUpdate_Config.txt")
  end]]
  if ftp_file==nil then
     the_most_new=false
   else
      local remote_config={}
     remote_config=unserialize(ftp_file)
    --local is_updated=false
    local log=""
    for k,c in pairs(remote_config) do
     local output=c.path..c.filename
	 --print(output)
	 local md5=""
	 f = io.open (output, "rb")
      if f then
         md5=utils.tohex (utils.md5 (f:read ("*a")))
	     -- print(md5)
		 f:close ()
      end -- if
      if md5=="" or md5~=c.md5 then  --不同服务器上版本
		 the_most_new=false --不是最新的
		 break
	  end
    end
   end

	 win="auto_update_btn"
	  --text add
	  WindowFont (win, "f", "宋体", 9, true, false, false, false)

	     switch_name=""
		 ColourNote("red", "black", "检查版本更新")

	  WindowRectOp (win, miniwin.rect_fill, 0,0,15,15,0x000010)  -- raised, filled, softer, flat
      WindowCircleOp (win, miniwin.circle_round_rectangle, 0, 0, 15, 15, 0xc0c0c0, 0, 1,0, 0, 9, 9)
       if the_most_new==true then
		WindowText (win, "f", switch_name,2,2,130,30,ColourNameToRGB ("green"), false) -- not Unicode
		world.EnableTimer("update_check",true)
	   else
		WindowText (win, "f", switch_name,2,2,130,30,ColourNameToRGB ("red"), false) -- not Unicode
		world.EnableTimer("update_check",false)
	  end
	  WindowShow (win,  true)  -- show it
   end)

   local e
   ftp_file, e = ftp.get("ftp://122.152.208.225//mushclient//AutoUpdate_Config.txt")
   --print(ftp_file)
   coroutine.resume(ftp_co)

end

--[[
function auto_check()
  local e
  ftp_file,e = ftp.get("ftp://122.152.208.225//mushclient//AutoUpdate_Config.txt")

  local co=coroutine.create(function()

    --下载服务器上的配置文件进行比对
   --print(f,"******")
    if f==nil then
	    print("挂起")
	   coroutine.yield()
	end
    if f==nil then
      print("连接超时！！！")
	  return
    end
   local remote_config={}
   remote_config=unserialize(f)
   local is_updated=false
   local log=""
   for k,c in pairs(remote_config) do
     local output=c.path..c.filename

	 local md5=""
	 f = io.open (output, "rb")
      if f then
         md5=utils.tohex (utils.md5 (f:read ("*a")))
		 --print(md5)
		 f:close ()
      end -- if
	  --print(c.md5,"  c.md5")
      if md5=="" or md5~=c.md5 then  --不同服务器上版本

		  is_updated=true
	      log=log.."更新模块:"..c.description.." 文件:"..c.filename.."\n"
		  if c.log==nil then c.log="" end
		  log=log..c.log.."\n"

	  end

   end
   if is_updated then


	    world.ColourNote ("blue", "black", "机器人发现有更新！！！")
		print("")
		world.ColourNote ("green", "red", "更新内容")
		 world.ColourNote ("red", "black", "-------------------------")
		world.ColourNote ("yellow", "gray",log)
		 world.ColourNote ("red", "black", "-------------------------")
         world.ColourNote ("green", "red", "请点击按钮进行更新!")
		local yesno=utils.msgbox ("是否要更新机器人", "更新", "yesno", "?")
		 if yesno=="yes" then
            check()
         end
   else
	  print("未发现更新！")
   end
   end)
   coroutine.resume(co)
end]]

local function _init()
    --world.ColourNote("salmon", "", "up:check           - 版本更新")
    --world.ColourNote("salmon", "", "up:create          - 创建更新文件")
	--world.ColourNote("salmon", "", "up:auto_check          - 检查版本更新")
	world.AddAlias("up_check", "up:check", "check()", alias_flag.Enabled, "")
    world.SetAliasOption ("up_check", "send_to", 12) --向脚本发送
	world.AddAlias("up_create", "up:create", "create()", alias_flag.Enabled, "")
    world.SetAliasOption ("up_create", "send_to", 12) --向脚本发送
	--world.AddAlias("up_auto_check", "up:auto_check", "auto_check()", alias_flag.Enabled, "")
    --world.SetAliasOption ("up_auto_check", "send_to", 12) --向脚本发送
end

function OnPluginClose()
end

function OnPluginConnect()

end

function OnPluginDisable()
end

function OnPluginDisconnect()
end

function OnPluginEnable()

end

function mousedown()
  return function (flags, hotspot_id)
    --print(flags)

	if flags==16 then
      check()
	end
  end
end

function OnPluginInstall()
   --ColourNote("white", "red", "叶知秋版_for_书剑_检查更新插件0.3版")
   _init()
   win="auto_update_btn"
   WindowCreate(win,0,0,15,15,miniwin.pos_center_right,0,0x909090)
   local _mousedown=mousedown()
   _G["at_mousedown"]=_mousedown
   WindowAddHotspot(win, "auto_update_hotspot",
                    0,  0, 15, 15,   -- rectangle
                   "",   -- MouseOver
                   "",   -- CancelMouseOver
                   "at_mousedown",  -- MouseDown
                   "",   -- CancelMouseDown
                   "",   -- MouseUp
                   "检查机器人更新",  -- tooltip text
                   cursor or 1, -- cursor
                   0)  -- flags
   button()

   --自动检查更新
   	world.AddTimer ("update_check", 24, 0, 0, "reload_plugin()", timer_flag.Replace, "")
    world.SetTimerOption ("update_check", "send_to", 12)
end

function reload_plugin()
   world.DoAfterSpecial (1,"ReloadPlugin('5c589f1ca4fd208978a46254')",12)
end

function OnPluginSend(sText)
end

function button()
  -- print("测试1")
   is_up_to_date()
  -- print("测试2")
end



]]>
</script>


</muclient>
